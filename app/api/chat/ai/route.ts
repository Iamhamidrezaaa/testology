import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

// âš™ï¸ Ø§ØªØµØ§Ù„ Ø¨Ù‡ API GPT (Ø§Ú¯Ø± API key ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
let openai: OpenAI | null = null;
if (process.env.OPENAI_API_KEY) {
  try {
    openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });
  } catch (error) {
    console.warn('OpenAI initialization failed:', error);
  }
}

// ØªØ§Ø¨Ø¹ fallback Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡
function generateFallbackResponse(message: string): string {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('Ø§Ø¶Ø·Ø±Ø§Ø¨') || lowerMessage.includes('Ù†Ú¯Ø±Ø§Ù†')) {
    return 'Ø¯Ø±Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù… Ú©Ù‡ Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø³ÛŒØ§Ø± Ù†Ø§Ø±Ø§Ø­Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ø§Ø´Ø¯. Ú†Ù†Ø¯ Ø±Ø§Ù‡Ú©Ø§Ø± Ø³Ø§Ø¯Ù‡ Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ù…Ú© Ú©Ù†Ø¯:\n\n1. ØªÙ†ÙØ³ Ø¹Ù…ÛŒÙ‚: Ù†ÙØ³ Ø¹Ù…ÛŒÙ‚ Ø¨Ú©Ø´ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø¢Ø±Ø§Ù…ÛŒ Ø¨Ø§Ø²Ø¯Ù… Ú©Ù†ÛŒØ¯ (Û´ Ø«Ø§Ù†ÛŒÙ‡ Ø¯Ù…ØŒ Û´ Ø«Ø§Ù†ÛŒÙ‡ Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯ØŒ Û´ Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø§Ø²Ø¯Ù…)\n2. ØªÙ…Ø±ÛŒÙ†Ø§Øª Ø¢Ø±Ø§Ù…Ø´: Ø³Ø¹ÛŒ Ú©Ù†ÛŒØ¯ Ø¹Ø¶Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø´Ù„ Ú©Ù†ÛŒØ¯\n3. Ù†ÙˆØ´ØªÙ†: Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø±ÙˆÛŒ Ú©Ø§ØºØ° Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯\n4. ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ: Ø­ØªÛŒ ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ Ú©ÙˆØªØ§Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ù…Ú© Ú©Ù†Ø¯\n\nØ§Ú¯Ø± Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ù…Ø§ Ø´Ø¯ÛŒØ¯ Ø§Ø³Øª ÛŒØ§ Ø¯Ø± Ø²Ù†Ø¯Ú¯ÛŒ Ø±ÙˆØ²Ù…Ø±Ù‡ Ø§Ø®ØªÙ„Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯.';
  }
  
  if (lowerMessage.includes('Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ') || lowerMessage.includes('ØºÙ…') || lowerMessage.includes('Ù†Ø§Ø±Ø§Ø­Øª')) {
    return 'Ù…ØªØ£Ø³ÙÙ… Ú©Ù‡ Ø§ÛŒÙ† Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø±Ø§ ØªØ¬Ø±Ø¨Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯. Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø³ÛŒØ§Ø± Ø³Ø®Øª Ø¨Ø§Ø´Ø¯. Ú†Ù†Ø¯ Ù†Ú©ØªÙ‡ Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ù…Ú© Ú©Ù†Ø¯:\n\n1. Ø§Ø±ØªØ¨Ø§Ø· Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ: Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù† ÛŒØ§ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ù‡ Ø¢Ù†â€ŒÙ‡Ø§ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¯Ø§Ø±ÛŒØ¯ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯\n2. ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú©: Ø­ØªÛŒ Ú©Ø§Ø±Ù‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ø±ÙˆØ²Ù…Ø±Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ù…Ú© Ú©Ù†Ø¯\n3. Ø±ÙˆØªÛŒÙ† Ù…Ù†Ø¸Ù…: Ø³Ø¹ÛŒ Ú©Ù†ÛŒØ¯ ÛŒÚ© Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ù†Ø¸Ù… Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ø¨ Ùˆ ØºØ°Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯\n4. Ú©Ù…Ú© Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ: Ø§Ú¯Ø± Ø§ÛŒÙ† Ø§Ø­Ø³Ø§Ø³Ø§Øª Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ ÛŒÚ© Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³ ÛŒØ§ Ø±ÙˆØ§Ù†Ù¾Ø²Ø´Ú© Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯\n\nÛŒØ§Ø¯ØªØ§Ù† Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ú©Ù…Ú© Ú¯Ø±ÙØªÙ† Ù†Ø´Ø§Ù†Ù‡ Ø¶Ø¹Ù Ù†ÛŒØ³ØªØŒ Ø¨Ù„Ú©Ù‡ Ù†Ø´Ø§Ù†Ù‡ Ø´Ø¬Ø§Ø¹Øª Ø§Ø³Øª.';
  }
  
  if (lowerMessage.includes('Ø§Ø³ØªØ±Ø³') || lowerMessage.includes('ÙØ´Ø§Ø±')) {
    return 'Ø§Ø³ØªØ±Ø³ Ø¨Ø®Ø´ Ø·Ø¨ÛŒØ¹ÛŒ Ø²Ù†Ø¯Ú¯ÛŒ Ø§Ø³ØªØŒ Ø§Ù…Ø§ ÙˆÙ‚ØªÛŒ Ø²ÛŒØ§Ø¯ Ø´ÙˆØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ø´Ú©Ù„â€ŒØ³Ø§Ø² Ø¨Ø§Ø´Ø¯. Ø±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³ØªØ±Ø³:\n\n1. Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…Ù†Ø¨Ø¹ Ø§Ø³ØªØ±Ø³: Ø¨Ø¨ÛŒÙ†ÛŒØ¯ Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¨Ø§Ø¹Ø« Ø§Ø³ØªØ±Ø³ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯\n2. Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ: Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯\n3. Ø§Ø³ØªØ±Ø§Ø­Øª: Ø¨Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø§Ø³ØªØ±Ø§Ø­Øª Ø¨Ø¯Ù‡ÛŒØ¯\n4. ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ø¢Ø±Ø§Ù…Ø´: Ù…Ø¯ÛŒØªÛŒØ´Ù† ÛŒØ§ ÛŒÙˆÚ¯Ø§ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯\n5. ÙˆØ±Ø²Ø´ Ù…Ù†Ø¸Ù…: ÙØ¹Ø§Ù„ÛŒØª Ø¨Ø¯Ù†ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø§Ø³ØªØ±Ø³ Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡Ø¯\n\nØ§Ú¯Ø± Ø§Ø³ØªØ±Ø³ Ø´Ù…Ø§ Ø´Ø¯ÛŒØ¯ Ø§Ø³ØªØŒ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…Ø´ÙˆØ±Øª Ú©Ù†ÛŒØ¯.';
  }
  
  // Ù¾Ø§Ø³Ø® Ù¾ÛŒØ´â€ŒÙØ±Ø¶
  return 'Ù…ØªØ´Ú©Ø±Ù… Ú©Ù‡ Ø¨Ø§ Ù…Ù† Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ú¯Ø°Ø§Ø´ØªÛŒØ¯. Ù…Ù† Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÙ… ØªØ§ Ø¯Ø± Ù…Ø³Ø§Ø¦Ù„ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù….\n\nØ§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…ÙˆØ¶ÙˆØ¹ Ø®Ø§ØµÛŒ ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨ÛŒØ´ØªØ± ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¯Ø± Ø²Ù…ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…:\n- Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¶Ø·Ø±Ø§Ø¨ Ùˆ Ø§Ø³ØªØ±Ø³\n- Ø¨Ù‡Ø¨ÙˆØ¯ Ø®Ù„Ù‚ Ùˆ Ø®Ùˆ\n- Ø±ÙˆØ§Ø¨Ø· Ø¨ÛŒÙ† ÙØ±Ø¯ÛŒ\n- Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨Ù‡ Ù†ÙØ³\n- Ùˆ Ø³Ø§ÛŒØ± Ù…Ø³Ø§Ø¦Ù„ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ\n\nÙ‡Ù…Ú†Ù†ÛŒÙ† Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù…Ú© ÙÙˆØ±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ù…Ø±Ø§Ú©Ø² Ù…Ø´Ø§ÙˆØ±Ù‡ ÛŒØ§ Ø®Ø·ÙˆØ· Ø¨Ø­Ø±Ø§Ù† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.';
}

export async function POST(request: NextRequest) {
  try {
    const { message, history } = await request.json();

    if (!message) {
      return NextResponse.json(
        { error: 'Ù¾ÛŒØ§Ù… Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø³Øª' },
        { status: 400 }
      );
    }

    console.log('ğŸ“¨ Chat request received:', { messageLength: message.length, historyLength: history?.length || 0 });

    // Ø§Ú¯Ø± OpenAI API key ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø² fallback Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if (!openai || !process.env.OPENAI_API_KEY) {
      console.log('âš ï¸ OpenAI API key not found, using fallback response');
      const fallbackResponse = generateFallbackResponse(message);
      return NextResponse.json({
        success: true,
        response: fallbackResponse
      });
    }

    // Ø³Ø§Ø®Øª Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³
    const systemPrompt = `Ø´Ù…Ø§ ÛŒÚ© Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³ Ù…ØªØ®ØµØµ Ùˆ Ø¨Ø§ØªØ¬Ø±Ø¨Ù‡ Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ø¯Ø± Testology Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯. 
    
    Ù†Ù‚Ø´ Ø´Ù…Ø§:
    - Ø§Ø±Ø§Ø¦Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
    - Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† ÙØ¹Ø§Ù„ Ùˆ Ù‡Ù…Ø¯Ù„Ø§Ù†Ù‡
    - Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ú©Ù„Ø§Øª Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ
    - ØªØ´Ø®ÛŒØµ Ø¹Ù„Ø§Ø¦Ù… Ù‡Ø´Ø¯Ø§Ø±Ø¯Ù‡Ù†Ø¯Ù‡ Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…ØªØ®ØµØµØ§Ù† Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
    
    Ø§ØµÙˆÙ„ Ú©Ø§Ø± Ø´Ù…Ø§:
    1. ÙÙ‚Ø· Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³ÛŒØŒ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†ØŒ Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø±ÙˆØ§Ø¨Ø· Ùˆ Ù…Ø³Ø§Ø¦Ù„ Ø´Ø®ØµÛŒ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯
    2. Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª ØºÛŒØ±Ù…Ø±ØªØ¨Ø· (Ø±ÛŒØ§Ø¶ÛŒØŒ Ù†Ø¬ÙˆÙ…ØŒ ÙÛŒØ²ÛŒÚ©ØŒ Ùˆ...) Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ú©Ù‡ ÙÙ‚Ø· Ø¯Ø± Ø²Ù…ÛŒÙ†Ù‡ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³ÛŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©Ù…Ú© Ú©Ù†ÛŒØ¯
    3. Ù‡Ù…Ø¯Ù„Ø§Ù†Ù‡ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯
    4. Ø±Ø§Ù‡Ú©Ø§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯
    5. Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø¯Ø§Ø®Ù„Ù‡ ÙÙˆØ±ÛŒØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ Ù…Ø±Ø§Ú©Ø² ØªØ®ØµØµÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ø¯Ù‡ÛŒØ¯
    6. Ø§Ø² Ø§ØµØ·Ù„Ø§Ø­Ø§Øª ØªØ®ØµØµÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ù¾Ø±Ù‡ÛŒØ² Ú©Ù†ÛŒØ¯
    7. Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø¨Ø§ Ù„Ø­Ù† Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯
    
    Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø³ÙˆØ§Ù„ ØºÛŒØ±Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³ÛŒ Ø¨Ù¾Ø±Ø³Ø¯ØŒ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ø¨Ú¯ÙˆÛŒÛŒØ¯:
    "Ù…ØªØ£Ø³ÙÙ…ØŒ Ù…Ù† ÙÙ‚Ø· Ø¯Ø± Ø²Ù…ÛŒÙ†Ù‡ Ù…Ø³Ø§Ø¦Ù„ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ Ùˆ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…. Ù„Ø·ÙØ§Ù‹ Ø³ÙˆØ§Ù„Ø§Øª Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø±ÙˆØ§Ø¨Ø·ØŒ Ø§Ø¶Ø·Ø±Ø§Ø¨ØŒ Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ùˆ Ø³Ø§ÛŒØ± Ù…Ø³Ø§Ø¦Ù„ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø®ØªÛŒ Ø±Ø§ Ù…Ø·Ø±Ø­ Ú©Ù†ÛŒØ¯."`;

    // Ø³Ø§Ø®Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡
    const messages = [
      { role: 'system', content: systemPrompt },
      ...(history || []).map((msg: any) => ({
        role: msg.role,
        content: msg.content
      })),
      { role: 'user', content: message }
    ];

    try {
      const completion = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: messages as any,
        max_tokens: 1000,
        temperature: 0.7,
      });

      const response = completion.choices[0]?.message?.content || 'Ù…ØªØ£Ø³ÙÙ…ØŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.';

      console.log('âœ… OpenAI response received:', response.substring(0, 100));

      return NextResponse.json({
        success: true,
        response: response
      });
    } catch (openaiError: any) {
      console.error('âŒ OpenAI API error:', openaiError?.message);
      // Ø§Ú¯Ø± OpenAI Ø®Ø·Ø§ Ø¯Ø§Ø¯ØŒ Ø§Ø² fallback Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
      const fallbackResponse = generateFallbackResponse(message);
      return NextResponse.json({
        success: true,
        response: fallbackResponse
      });
    }

  } catch (error: any) {
    console.error('âŒ Error in AI chat API:', error);
    console.error('Error stack:', error?.stack);
    console.error('Error message:', error?.message);
    
    // Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ ÛŒÚ© Ù¾Ø§Ø³Ø® fallback Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
    const fallbackResponse = generateFallbackResponse(message || '');
    return NextResponse.json({
      success: true,
      response: fallbackResponse,
      error: process.env.NODE_ENV === 'development' ? error?.message : undefined
    });
  }
}
