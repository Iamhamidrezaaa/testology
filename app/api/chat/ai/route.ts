import { NextRequest, NextResponse } from 'next/server';
import { getOpenAI } from '@/lib/openai';

export const dynamic = "force-dynamic";
export const revalidate = 0;

// ุชุงุจุน fallback ุจุฑุง ูพุงุณุฎโูุง ุณุงุฏู
function generateFallbackResponse(message: string): string {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('ุงุถุทุฑุงุจ') || lowerMessage.includes('ูฺฏุฑุงู')) {
    return 'ุฏุฑฺฉ ูโฺฉูู ฺฉู ุงุถุทุฑุงุจ ูโุชูุงูุฏ ุจุณุงุฑ ูุงุฑุงุญุชโฺฉููุฏู ุจุงุดุฏ. ฺูุฏ ุฑุงูฺฉุงุฑ ุณุงุฏู ฺฉู ูโุชูุงูุฏ ฺฉูฺฉ ฺฉูุฏ:\n\n1. ุชููุณ ุนูู: ููุณ ุนูู ุจฺฉุดุฏ ู ุจู ุขุฑุงู ุจุงุฒุฏู ฺฉูุฏ (ด ุซุงูู ุฏูุ ด ุซุงูู ูฺฏู ุฏุงุฑุฏุ ด ุซุงูู ุจุงุฒุฏู)\n2. ุชูุฑูุงุช ุขุฑุงูุด: ุณุน ฺฉูุฏ ุนุถูุงุช ุฎูุฏ ุฑุง ุดู ฺฉูุฏ\n3. ููุดุชู: ุงุญุณุงุณุงุช ุฎูุฏ ุฑุง ุฑู ฺฉุงุบุฐ ุจููุณุฏ\n4. ูุนุงูุช ุจุฏู: ุญุช ฺฉ ูพุงุฏูโุฑู ฺฉูุชุงู ูโุชูุงูุฏ ฺฉูฺฉ ฺฉูุฏ\n\nุงฺฏุฑ ุงุถุทุฑุงุจ ุดูุง ุดุฏุฏ ุงุณุช ุง ุฏุฑ ุฒูุฏฺฏ ุฑูุฒูุฑู ุงุฎุชูุงู ุงุฌุงุฏ ูโฺฉูุฏุ ุชูุตู ูโฺฉูู ุจุง ฺฉ ูุชุฎุตุต ุณูุงูุช ุฑูุงู ูุดูุฑุช ฺฉูุฏ.';
  }
  
  if (lowerMessage.includes('ุงูุณุฑุฏฺฏ') || lowerMessage.includes('ุบู') || lowerMessage.includes('ูุงุฑุงุญุช')) {
    return 'ูุชุฃุณูู ฺฉู ุงู ุงุญุณุงุณุงุช ุฑุง ุชุฌุฑุจู ูโฺฉูุฏ. ุงูุณุฑุฏฺฏ ูโุชูุงูุฏ ุจุณุงุฑ ุณุฎุช ุจุงุดุฏ. ฺูุฏ ูฺฉุชู ฺฉู ููฺฉู ุงุณุช ฺฉูฺฉ ฺฉูุฏ:\n\n1. ุงุฑุชุจุงุท ุงุฌุชูุงุน: ุจุง ุฏูุณุชุงู ุง ุฎุงููุงุฏูโุง ฺฉู ุจู ุขูโูุง ุงุนุชูุงุฏ ุฏุงุฑุฏ ุตุญุจุช ฺฉูุฏ\n2. ูุนุงูุชโูุง ฺฉูฺฺฉ: ุญุช ฺฉุงุฑูุง ฺฉูฺฺฉ ุฑูุฒูุฑู ูโุชูุงูุฏ ฺฉูฺฉ ฺฉูุฏ\n3. ุฑูุชู ููุธู: ุณุน ฺฉูุฏ ฺฉ ุจุฑูุงูู ููุธู ุจุฑุง ุฎูุงุจ ู ุบุฐุง ุฏุงุดุชู ุจุงุดุฏ\n4. ฺฉูฺฉ ุญุฑููโุง: ุงฺฏุฑ ุงู ุงุญุณุงุณุงุช ุงุฏุงูู ุฏุงุฑุฏุ ุจุง ฺฉ ุฑูุงูโุดูุงุณ ุง ุฑูุงููพุฒุดฺฉ ูุดูุฑุช ฺฉูุฏ\n\nุงุฏุชุงู ุจุงุดุฏ ฺฉู ฺฉูฺฉ ฺฏุฑูุชู ูุดุงูู ุถุนู ูุณุชุ ุจูฺฉู ูุดุงูู ุดุฌุงุนุช ุงุณุช.';
  }
  
  if (lowerMessage.includes('ุงุณุชุฑุณ') || lowerMessage.includes('ูุดุงุฑ')) {
    return 'ุงุณุชุฑุณ ุจุฎุด ุทุจุน ุฒูุฏฺฏ ุงุณุชุ ุงูุง ููุช ุฒุงุฏ ุดูุฏ ูโุชูุงูุฏ ูุดฺฉูโุณุงุฒ ุจุงุดุฏ. ุฑุงูฺฉุงุฑูุง ูุฏุฑุช ุงุณุชุฑุณ:\n\n1. ุดูุงุณุง ููุจุน ุงุณุชุฑุณ: ุจุจูุฏ ฺู ฺุฒ ุจุงุนุซ ุงุณุชุฑุณ ุดูุง ูโุดูุฏ\n2. ุงูููุชโุจูุฏ: ฺฉุงุฑูุง ุฎูุฏ ุฑุง ุงูููุชโุจูุฏ ฺฉูุฏ\n3. ุงุณุชุฑุงุญุช: ุจู ุฎูุฏุชุงู ุงุณุชุฑุงุญุช ุจุฏูุฏ\n4. ุชฺฉูฺฉโูุง ุขุฑุงูุด: ูุฏุชุดู ุง ูฺฏุง ุฑุง ุงูุชุญุงู ฺฉูุฏ\n5. ูุฑุฒุด ููุธู: ูุนุงูุช ุจุฏู ูโุชูุงูุฏ ุงุณุชุฑุณ ุฑุง ฺฉุงูุด ุฏูุฏ\n\nุงฺฏุฑ ุงุณุชุฑุณ ุดูุง ุดุฏุฏ ุงุณุชุ ุญุชูุงู ุจุง ฺฉ ูุชุฎุตุต ูุดูุฑุช ฺฉูุฏ.';
  }
  
  // ูพุงุณุฎ ูพุดโูุฑุถ
  return 'ูุชุดฺฉุฑู ฺฉู ุจุง ูู ุจู ุงุดุชุฑุงฺฉ ฺฏุฐุงุดุชุฏ. ูู ุงูุฌุง ูุณุชู ุชุง ุฏุฑ ูุณุงุฆู ุฑูุงูโุดูุงุฎุช ุจู ุดูุง ฺฉูฺฉ ฺฉูู.\n\nุงฺฏุฑ ูโุฎูุงูุฏ ุฏุฑุจุงุฑู ููุถูุน ุฎุงุต ุตุญุจุช ฺฉููุ ูุทูุงู ุจุดุชุฑ ุชูุถุญ ุฏูุฏ. ูโุชูุงูู ุฏุฑ ุฒูููโูุง ุฒุฑ ุจู ุดูุง ฺฉูฺฉ ฺฉูู:\n- ูุฏุฑุช ุงุถุทุฑุงุจ ู ุงุณุชุฑุณ\n- ุจูุจูุฏ ุฎูู ู ุฎู\n- ุฑูุงุจุท ุจู ูุฑุฏ\n- ุงุนุชูุงุฏ ุจู ููุณ\n- ู ุณุงุฑ ูุณุงุฆู ุฑูุงูโุดูุงุฎุช\n\nููฺูู ุงฺฏุฑ ูุงุฒ ุจู ฺฉูฺฉ ููุฑ ุฏุงุฑุฏุ ูโุชูุงูุฏ ุจุง ูุฑุงฺฉุฒ ูุดุงูุฑู ุง ุฎุทูุท ุจุญุฑุงู ุชูุงุณ ุจฺฏุฑุฏ.';
}

export async function POST(request: NextRequest): Promise<Response> {
  let message = '';
  try {
    const body = await request.json();
    message = body.message || '';
    const history = body.history;

    if (!message) {
      return NextResponse.json(
        { error: 'ูพุงู ููุฑุฏ ูุงุฒ ุงุณุช' },
        { status: 400 }
      );
    }

    console.log('๐จ Chat request received:', { messageLength: message.length, historyLength: history?.length || 0 });

    const openai = getOpenAI();
    
    // ุงฺฏุฑ OpenAI API key ูุฌูุฏ ูุฏุงุฑุฏุ ุงุฒ fallback ุงุณุชูุงุฏู ฺฉู
    if (!openai) {
      console.log('โ๏ธ OpenAI API key not found, using fallback response');
      const fallbackResponse = generateFallbackResponse(message);
      return NextResponse.json({
        success: true,
        response: fallbackResponse
      });
    }

    // ุณุงุฎุช ุณุณุชู ูพุฑุงููพุช ุจุฑุง ุฑูุงูโุดูุงุณ
    const systemPrompt = `ุดูุง ฺฉ ุฑูุงูโุดูุงุณ ูุชุฎุตุต ู ุจุงุชุฌุฑุจู ูุณุชุฏ ฺฉู ุฏุฑ Testology ฺฉุงุฑ ูโฺฉูุฏ. 
    
    ููุด ุดูุง:
    - ุงุฑุงุฆู ูุดุงูุฑู ุฑูุงูโุดูุงุฎุช ุญุฑููโุง
    - ฺฏูุด ุฏุงุฏู ูุนุงู ู ููุฏูุงูู
    - ุงุฑุงุฆู ุฑุงูฺฉุงุฑูุง ุนูู ุจุฑุง ูุดฺฉูุงุช ุฑูุงูโุดูุงุฎุช
    - ุชุดุฎุต ุนูุงุฆู ูุดุฏุงุฑุฏููุฏู ู ุงุฑุฌุงุน ุจู ูุชุฎุตุตุงู ุฏุฑ ุตูุฑุช ูุงุฒ
    
    ุงุตูู ฺฉุงุฑ ุดูุง:
    1. ููุท ุจู ุณูุงูุงุช ูุฑุชุจุท ุจุง ุฑูุงูโุดูุงุณุ ุณูุงูุช ุฑูุงูุ ุงุญุณุงุณุงุชุ ุฑูุงุจุท ู ูุณุงุฆู ุดุฎุต ูพุงุณุฎ ุฏูุฏ
    2. ุจุฑุง ุณูุงูุงุช ุบุฑูุฑุชุจุท (ุฑุงุถุ ูุฌููุ ูุฒฺฉุ ู...) ูุญุชุฑูุงูู ุจฺฏูุฏ ฺฉู ููุท ุฏุฑ ุฒููู ุฑูุงูโุดูุงุณ ูโุชูุงูุฏ ฺฉูฺฉ ฺฉูุฏ
    3. ููุฏูุงูู ู ุญุฑููโุง ูพุงุณุฎ ุฏูุฏ
    4. ุฑุงูฺฉุงุฑูุง ุนูู ู ูุงุจู ุงุฌุฑุง ุงุฑุงุฆู ุฏูุฏ
    5. ุฏุฑ ุตูุฑุช ูุงุฒ ุจู ูุฏุงุฎูู ููุฑุ ฺฉุงุฑุจุฑ ุฑุง ุจู ูุฑุงฺฉุฒ ุชุฎุตุต ุงุฑุฌุงุน ุฏูุฏ
    6. ุงุฒ ุงุตุทูุงุญุงุช ุชุฎุตุต ูพฺุฏู ูพุฑูุฒ ฺฉูุฏ
    7. ูพุงุณุฎโูุง ุฑุง ุจู ูุงุฑุณ ู ุจุง ูุญู ุฏูุณุชุงูู ุจููุณุฏ
    
    ุงฺฏุฑ ฺฉุงุฑุจุฑ ุณูุงู ุบุฑูุฑุชุจุท ุจุง ุฑูุงูโุดูุงุณ ุจูพุฑุณุฏุ ูุญุชุฑูุงูู ุจฺฏูุฏ:
    "ูุชุฃุณููุ ูู ููุท ุฏุฑ ุฒููู ูุณุงุฆู ุฑูุงูโุดูุงุฎุช ู ุณูุงูุช ุฑูุงู ูโุชูุงูู ุจู ุดูุง ฺฉูฺฉ ฺฉูู. ูุทูุงู ุณูุงูุงุช ูุฑุชุจุท ุจุง ุงุญุณุงุณุงุชุ ุฑูุงุจุทุ ุงุถุทุฑุงุจุ ุงูุณุฑุฏฺฏ ู ุณุงุฑ ูุณุงุฆู ุฑูุงูโุดูุงุฎุช ุฑุง ูุทุฑุญ ฺฉูุฏ."`;

    // ุณุงุฎุช ุชุงุฑุฎฺู ูฺฉุงููู
    const messages = [
      { role: 'system', content: systemPrompt },
      ...(history || []).map((msg: any) => ({
        role: msg.role,
        content: msg.content
      })),
      { role: 'user', content: message }
    ];

    try {
      const completion = await openai.chat.completions.create({
        model: 'gpt-4o-mini',
        messages: messages as any,
        max_tokens: 1000,
        temperature: 0.7,
      });

      const response = completion.choices[0]?.message?.content || 'ูุชุฃุณููุ ุฎุทุง ุฑุฎ ุฏุงุฏ.';

      console.log('โ OpenAI response received:', response.substring(0, 100));

      return NextResponse.json({
        success: true,
        response: response
      });
    } catch (openaiError: any) {
      console.error('โ OpenAI API error:', openaiError?.message);
      // ุงฺฏุฑ OpenAI ุฎุทุง ุฏุงุฏุ ุงุฒ fallback ุงุณุชูุงุฏู ฺฉู
      const fallbackResponse = generateFallbackResponse(message);
      return NextResponse.json({
        success: true,
        response: fallbackResponse
      });
    }

  } catch (error: any) {
    console.error('โ Error in AI chat API:', error);
    console.error('Error stack:', error?.stack);
    console.error('Error message:', error?.message);
    
    // ุญุช ุฏุฑ ุตูุฑุช ุฎุทุงุ ฺฉ ูพุงุณุฎ fallback ุจุฑฺฏุฑุฏุงู
    const fallbackResponse = generateFallbackResponse(message || 'ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ุฏุฑุฎูุงุณุช');
    return NextResponse.json({
      success: true,
      response: fallbackResponse,
      error: process.env.NODE_ENV === 'development' ? error?.message : undefined
    });
  }
}
